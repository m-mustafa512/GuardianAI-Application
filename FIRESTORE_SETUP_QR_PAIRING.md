# Firestore Setup for QR Pairing

## Required Collections

The QR pairing feature requires the following Firestore collections:

### 1. `pairing_tokens` Collection
**Purpose:** Stores temporary pairing tokens generated by parent devices

**Document Structure:**
```json
{
  "parentUid": "string",
  "parentEmail": "string",
  "pairToken": "string (UUID)",
  "expiresAt": "number (timestamp)",
  "timestamp": "number (timestamp)"
}
```

**Document ID:** The `pairToken` value (UUID)

**Lifecycle:** 
- Created when parent generates QR code
- Deleted after successful pairing or expiration

---

### 2. `users` Collection
**Purpose:** Stores user accounts (both parent and child)

**Document Structure:**
```json
{
  "uid": "string (Firebase Auth UID)",
  "email": "string",
  "displayName": "string",
  "role": "string (PARENT or CHILD)",
  "parentUid": "string (only for child users)",
  "deviceId": "string",
  "emailVerified": "boolean",
  "createdAt": "number (timestamp)"
}
```

**Document ID:** The user's Firebase Auth UID

**Notes:**
- Child users have `role: "CHILD"` and `parentUid` set
- Child users have empty `email` string
- `deviceId` is the Android device ID (ANDROID_ID)

---

### 3. `device_pairs` Collection
**Purpose:** Links parent and child devices together

**Document Structure:**
```json
{
  "pairId": "string (UUID)",
  "parentUid": "string",
  "childUid": "string",
  "parentDeviceId": "string",
  "childDeviceId": "string",
  "pairedAt": "number (timestamp)",
  "isActive": "boolean"
}
```

**Document ID:** The `pairId` value (UUID)

---

### 4. `child_profiles` Collection
**Purpose:** Extended profile information for child users

**Document Structure:**
```json
{
  "profileId": "string (UUID)",
  "childUid": "string",
  "parentUid": "string",
  "name": "string",
  "age": "number",
  "deviceName": "string",
  "deviceType": "string (Android or iOS)",
  "profilePictureUrl": "string (optional)",
  "isOnline": "boolean",
  "lastSeen": "number (timestamp)",
  "currentLocation": "string (optional)",
  "screenTimeLimit": "number (seconds)",
  "screenTimeToday": "number (seconds)",
  "screenTimePercentage": "number",
  "createdAt": "number (timestamp)",
  "updatedAt": "number (timestamp)"
}
```

**Document ID:** The `profileId` value (UUID)

---

## Firestore Security Rules

You need to configure Firestore security rules to allow:

1. **Anonymous Authentication** - Child devices use anonymous authentication
2. **Read/Write Access** - For pairing operations

### Recommended Security Rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is parent
    function isParent() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'PARENT';
    }
    
    // Helper function to check if user is child
    function isChild() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CHILD';
    }
    
    // Pairing tokens - allow read/write for authenticated users during pairing
    match /pairing_tokens/{tokenId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Parents can read child user documents
      allow read: if isParent() && 
                     resource.data.parentUid == request.auth.uid;
      // Allow write during pairing (anonymous users creating child accounts)
      allow write: if isAuthenticated();
    }
    
    // Device pairs
    match /device_pairs/{pairId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Child profiles
    match /child_profiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Add other collection rules as needed...
  }
}
```

### Alternative: Development Rules (Less Secure - for testing only)

If you're still in development, you can use these simpler rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

**⚠️ WARNING:** The development rules above allow any authenticated user to read/write all documents. Only use for testing!

---

## Firebase Authentication Setup

### Enable Anonymous Authentication

1. Go to Firebase Console → Authentication
2. Click on "Sign-in method" tab
3. Enable "Anonymous" authentication provider
4. Save changes

---

## Testing the Setup

### Check Logs

The app now includes comprehensive logging. Check Android Logcat for:
- `QRPairingService` - Pairing process steps
- `QRScanActivity` - QR scanning and parsing
- `QRPairingData` - JSON parsing

### Expected Flow:

1. **Parent generates QR:**
   - Token created in `pairing_tokens` collection
   - QR code displayed

2. **Child scans QR:**
   - QR data parsed
   - Token verified in Firestore
   - Anonymous child account created
   - Child user document created in `users`
   - Device pair created in `device_pairs`
   - Child profile created in `child_profiles`
   - Token deleted from `pairing_tokens`

### Common Issues:

1. **"Invalid pairing token"** - Token expired or doesn't exist in Firestore
2. **"Failed to create child account"** - Anonymous auth not enabled
3. **"Permission denied"** - Firestore security rules blocking access
4. **"Failed to create child user"** - Firestore write permission issue

---

## Manual Firestore Setup (if needed)

If collections don't exist, Firestore will create them automatically when the first document is written. However, you can manually create them in Firebase Console:

1. Go to Firebase Console → Firestore Database
2. Click "Start collection"
3. Create each collection listed above
4. Collections will be created empty - documents will be added by the app

---

## Verification Checklist

- [ ] Anonymous authentication enabled in Firebase Console
- [ ] Firestore security rules configured (at minimum, allow authenticated users)
- [ ] All 4 collections exist (or will be auto-created):
  - [ ] `pairing_tokens`
  - [ ] `users`
  - [ ] `device_pairs`
  - [ ] `child_profiles`
- [ ] Test pairing flow and check Logcat for errors
- [ ] Verify documents are created in Firestore after successful pairing

